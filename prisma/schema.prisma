// Prisma schema para Wallet App

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(uuid())
  username      String    @unique
  email         String?   @unique
  passwordHash  String    @map("password_hash")
  fullName      String?   @map("full_name")
  avatarUrl     String?   @map("avatar_url")
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  authProviders    AuthProvider[]
  accounts         Account[]
  categories       Category[]
  transactions     Transaction[]
  transfers        Transfer[]
  tags             Tag[]

  @@map("users")
}

model AuthProvider {
  id              String   @id @default(uuid())
  userId          String   @map("user_id")
  provider        String   // 'local' | 'google'
  providerUserId  String?  @map("provider_user_id")
  providerEmail   String?  @map("provider_email")
  createdAt       DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerUserId])
  @@unique([userId, provider])
  @@map("auth_providers")
}

model Account {
  id              String   @id @default(uuid())
  userId          String   @map("user_id")
  name            String
  type            String   // 'cash' | 'bank' | 'card' | 'wallet'
  currency        String   @default("PEN")
  openingBalance  Decimal  @default(0) @map("opening_balance") @db.Decimal(12, 2)
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  user               User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions       Transaction[]
  transfersFrom      Transfer[]    @relation("TransfersFrom")
  transfersTo        Transfer[]    @relation("TransfersTo")

  @@index([userId])
  @@map("accounts")
}

model Category {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  name      String
  kind      String   // 'expense' | 'income' | 'both'
  icon      String?  // Emoji icon for the category
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  @@index([userId])
  @@map("categories")
}

model Transaction {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  accountId   String   @map("account_id")
  categoryId  String?  @map("category_id")
  type        String   // 'expense' | 'income'
  amount      Decimal  @db.Decimal(12, 2)
  date        DateTime
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  account  Account   @relation(fields: [accountId], references: [id], onDelete: Cascade)
  category Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  tags     TransactionTag[]

  @@index([userId, date(sort: Desc)])
  @@map("transactions")
}

model Transfer {
  id            String   @id @default(uuid())
  userId        String   @map("user_id")
  fromAccountId String   @map("from_account_id")
  toAccountId   String   @map("to_account_id")
  amount        Decimal  @db.Decimal(12, 2)
  date          DateTime
  description   String?
  createdAt     DateTime @default(now()) @map("created_at")

  user        User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  fromAccount Account @relation("TransfersFrom", fields: [fromAccountId], references: [id], onDelete: Cascade)
  toAccount   Account @relation("TransfersTo", fields: [toAccountId], references: [id], onDelete: Cascade)

  @@index([userId, date(sort: Desc)])
  @@map("transfers")
}

model Tag {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  name      String
  createdAt DateTime @default(now()) @map("created_at")

  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions   TransactionTag[]

  @@index([userId])
  @@map("tags")
}

model TransactionTag {
  transactionId String @map("transaction_id")
  tagId         String @map("tag_id")

  transaction Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  tag         Tag         @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([transactionId, tagId])
  @@map("transaction_tags")
}
